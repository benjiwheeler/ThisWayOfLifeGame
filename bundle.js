(()=>{const e=document.getElementById("gameCanvas").getContext("2d"),t=512,l=100,o=350;let n={x:248,y:o,width:16,height:24,umbrellaOpen:!1,umbrellaOpenTime:0,power:l},i=[],r=[],a=0,h=parseInt(localStorage.getItem("umbrellaHighScore")||"0"),f=!1,c={},s=10,y=!1,m=null,d=null,u=0,x=100,p="",g=0,w=10,b=3,M=0;const v=["they seem made from strange metallic material","they have small eyes that seem to watch me","i do not know them, but they know me","their surfaces shimmer with unknown symbols","they whisper in frequencies i cannot hear","each one carries a different weight","they fall in patterns, not chaos","they avoid hitting me directly","perhaps they are trying to communicate","their texture feels impossibly smooth"];function S(){r=[];const e=Math.ceil(16);for(let t=0;t<e;t++)r.push({x:32*t,width:32,count:0,height:0,obstacles:[]})}S();const k={woman:[[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,0,1,1,0,1,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0]],umbrellaClosed:[[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0]],umbrellaOpen:[[0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,0,1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,1,0,1,1,1],[1,1,0,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,0,1,1],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0]],cat:[[0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0],[0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0],[0,0,1,1,0,0,1,1,1,1,0,0,1,1,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,1,1,0,1,1,1,1,1,1,0,1,1,0,0],[0,0,1,1,0,0,1,1,1,1,0,0,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0],[0,0,1,0,0,0,0,1,1,0,0,0,0,1,0,0],[0,0,1,1,0,1,1,1,1,1,1,0,1,1,0,0],[0,0,0,1,1,1,1,0,0,1,1,1,1,0,0,0],[0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0],[0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0],[0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0]],meteor:[[0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,1,1,1,0,1,1,1,1,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,1,1,0,1,1,1,1,0,1,1,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[1,1,1,1,0,1,1,1,1,1,1,1,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,1,1,1,1,1,0,1,1,1,1,1,1,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,0,1,1,0,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],boot:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,1,1,0,0,0,0,0,0,0,1,1,1,1,0,0],[0,1,1,0,0,0,0,0,0,0,0,1,1,1,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0]],cokeCan:[[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,0,0,0,0,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,0,1,1,1,1,0,0,0,0]]};function A(t,l,o,n=2){const i=t.length,r=t[0].length;e.fillStyle="#000";for(let a=0;a<i;a++)for(let i=0;i<r;i++)1===t[a][i]&&e.fillRect(Math.floor(l+i*n),Math.floor(o+a*n),n,n)}const O=[{sprite:k.cat,width:16,height:16,name:"cat"},{sprite:k.meteor,width:16,height:16,name:"meteor"},{sprite:k.boot,width:16,height:16,name:"boot"},{sprite:k.cokeCan,width:12,height:16,name:"can"}];function E(e,t,l,o=2){const n=Math.floor(l/o),i=Math.floor(t/o);return!(n<0||n>=e.length||i<0||i>=e[0].length||1!==e[n][i])}function I(e,t,l=2,o=2){if(e.x>=t.x+t.width||e.x+e.width<=t.x||e.y>=t.y+t.height||e.y+e.height<=t.y)return!1;const n=Math.max(e.x,t.x),i=Math.min(e.x+e.width,t.x+t.width),r=Math.max(e.y,t.y),a=Math.min(e.y+e.height,t.y+t.height);for(let h=r;h<a;h+=2)for(let r=n;r<i;r+=2){const n=r-e.x,i=h-e.y,a=r-t.x,f=h-t.y,c=e.type?e.type.sprite:k.woman,s=t.type?t.type.sprite:k.woman;if(E(c,n,i,l)&&E(s,a,f,o))return!0}return!1}function R(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function T(e,t=!1){if(e.deflected)return null;let l=o;for(let o of r)for(let n of o.obstacles){if(t&&n===e)continue;if(!(e.x<n.x+n.width&&e.x+e.width>n.x))continue;const o=Math.max(e.x,n.x),i=Math.min(e.x+e.width,n.x+n.width);for(let t=o;t<i;t+=2){const o=t-e.x,i=t-n.x;let r=-1;for(let t=e.height-1;t>=0;t--)if(E(e.type.sprite,o,t,2)){r=t;break}if(-1===r)continue;let a=-1;for(let e=0;e<n.height;e++)if(E(n.type.sprite,i,e,2)){a=e;break}if(-1===a)continue;const h=n.y+a-(r+1);h<l&&(l=h)}}return l}function C(){document.getElementById("score").textContent=a,document.getElementById("highScore").textContent=h}window.addEventListener("keydown",e=>{if(c[e.key]=!0," "===e.key&&f&&(n.x=248,n.y=o,n.umbrellaOpen=!1,n.power=l,i=[],S(),a=0,f=!1,s=10,y=!1,m=null,d=null,u=0,p="",g=0,w=10,b=3,M=0,C()),y)return"a"===e.key||"A"===e.key?m?"learn"!==m||d||(d="faster",y=!1,u=0,b=4.5,w=15):(m="fight",y=!1,n.power=150,s=10):"b"!==e.key&&"B"!==e.key||(m?"learn"!==m||d||(d="meditate",y=!1,u=0):(m="learn",y=!1,s=10)),void e.preventDefault();["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)&&e.preventDefault()}),window.addEventListener("keyup",e=>{c[e.key]=!1}),C(),document.getElementById("version").textContent="1.6",function S(){(function(){if(f)return;if(y)return;g>0&&(g--,0===g&&(p="")),"learn"===m&&!d&&u>=x&&(y=!0);const e=function(e){const t=Math.floor(e/32);return t>=0&&t<r.length?r[t].count:0}(n.x+n.width/2),S=Math.max(.15,1-.2*e);let A=!1;c.ArrowLeft&&n.x>0&&(n.x-=b*S,A=!0),c.ArrowRight&&n.x<t-n.width&&(n.x+=b*S,A=!0),"meditate"===d&&(A||n.umbrellaOpen?M=0:(M++,M>=60&&(u=Math.min(x,u+1),M=0))),c.ArrowUp&&n.power>0?(n.umbrellaOpen=!0,n.umbrellaOpenTime=10,n.power=Math.max(0,n.power-.5)):(n.umbrellaOpenTime>0?n.umbrellaOpenTime--:n.umbrellaOpen=!1,n.umbrellaOpen||(n.power=Math.min(l,n.power+.1))),n.power<=0&&(n.umbrellaOpen=!1);for(let e=i.length-1;e>=0;e--){const t=i[e];if(!t.onGround){if(t.deflected)t.velocityY+=.3,t.y+=t.velocityY,t.x+=t.velocityX,t.trail=[];else{"meteor"===t.type.name&&(t.trail.unshift({x:t.x+t.width/2,y:t.y+t.height/2}),t.trail.length>8&&t.trail.pop()),t.y+=t.velocityY,t.x+=t.velocityX;const e=T(t);if(t.y+t.height>=e){t.y=e,t.onGround=!0,t.velocityY=0,t.velocityX=0,t.trail=[];const l=Math.floor((t.x+t.width/2)/32);l>=0&&l<r.length&&(r[l].count++,r[l].obstacles.push(t),!t.deflected&&s>0&&(s++,s>10&&(s=10)))}}if(n.umbrellaOpen&&!t.deflected&&!t.onGround){const e="fight"===m?64:48,l="fight"===m?-16:-8;R(t,{x:n.x+l,y:n.y-32,width:e,height:32})&&(t.deflected=!0,t.velocityY=-8,t.velocityX=(t.x-n.x)/10,a+=10,C(),s>0&&(s--,0!==s||m||(y=!0)))}"learn"!==m||"meditate"===d||t.deflected||t.onGround||!I(t,n)||(u=Math.min(x,u+w),p=v[Math.floor(Math.random()*v.length)],g=120,t.deflected=!0,t.velocityY=-2,t.velocityX=(t.x-n.x)/20),"learn"===m&&"meditate"!==d||t.deflected||t.onGround||!I(t,n)||(f=!0,a>h&&(h=a,localStorage.setItem("umbrellaHighScore",h),document.getElementById("highScore").textContent=h)),!t.onGround&&(t.y>434||t.y<-100||t.x<-100||t.x>612)&&i.splice(e,1)}}if(n.umbrellaOpen){const e="fight"===m?72:48,t="fight"===m?3:2,l="fight"===m?-16:-8,o={x:n.x+l,y:n.y-32,width:e,height:32,type:{sprite:k.umbrellaOpen}};for(let e of r)for(let l=e.obstacles.length-1;l>=0;l--){const i=e.obstacles[l];i.deflected||i.falling||!I(o,i,t,2)||(i.deflected=!0,i.onGround=!1,i.velocityY=-8,i.velocityX=(i.x-n.x)/10,e.obstacles.splice(l,1),e.count--,a+=5,C(),s>0&&(s--,0!==s||m||(y=!0)))}}for(let e of r)for(let t of e.obstacles)if(!t.falling&&!t.deflected){const e=T(t,!0);t.y<e-2&&(t.falling=!0,t.fallVelocityY=0)}for(let e of r)for(let t of e.obstacles)if(t.falling){t.fallVelocityY+=.3,t.y+=t.fallVelocityY;const e=T(t,!0);t.y>=e&&(t.y=e,t.falling=!1,t.fallVelocityY=0)}Math.random()<.02&&i.push(function(){const e=O[Math.floor(Math.random()*O.length)],l={x:Math.random()*(t-2*e.width),y:2*-e.height,width:2*e.width,height:2*e.height,velocityY:2+1*Math.random(),velocityX:0,type:e,deflected:!1,onGround:!1,trail:[]};if("meteor"===e.name){const o=Math.random()*Math.PI/3-Math.PI/6;l.velocityX=3*Math.sin(o),l.velocityY=3*Math.cos(o),l.velocityX<0?l.x=t+2*e.width:l.velocityX>0&&(l.x=2*-e.width)}return l}());for(let e of r)if(e.count>0&&o-32*e.count<=50){f=!0,a>h&&(h=a,localStorage.setItem("umbrellaHighScore",h),document.getElementById("highScore").textContent=h);break}})(),e.fillStyle="#fff",e.fillRect(0,0,t,384),r.forEach(e=>{e.obstacles.forEach(e=>{A(e.type.sprite,e.x,e.y)})}),i.forEach(t=>{t.onGround||function(t){if("meteor"===t.type.name&&!t.onGround&&t.trail.length>0){e.fillStyle="#000";for(let l=0;l<t.trail.length;l++){const o=t.trail[l],n=(t.trail.length,Math.max(1,4-l));for(let t=0;t<n;t++)for(let l=0;l<n;l++)Math.random()>.3&&e.fillRect(o.x+t,o.y+l,1,1)}}A(t.type.sprite,t.x,t.y)}(t)}),function(){if(A(k.woman,n.x,n.y),n.umbrellaOpen)if("fight"===m){const e=3;A(k.umbrellaOpen,n.x-16,n.y-40,e)}else A(k.umbrellaOpen,n.x-8,n.y-32);else A(k.umbrellaClosed,n.x+12,n.y+4)}(),function(){const t="fight"===m?150:100;e.strokeStyle="#000",e.lineWidth=2,e.strokeRect(10,10,t,12),e.fillStyle="#fff",e.fillRect(12,12,t-4,8);const o="fight"===m?150:l,i=Math.max(0,n.power/o*(t-4));e.fillStyle="#000",e.fillRect(12,12,i,8),e.fillStyle="#000",e.font="10px monospace",e.textAlign="left",e.fillText("POWER",10,8)}(),function(){if("learn"!==m)return;e.strokeStyle="#000",e.lineWidth=2,e.strokeRect(10,30,100,12),e.fillStyle="#fff",e.fillRect(12,32,96,8);const t=Math.max(0,u/x*96);e.fillStyle="#000",e.fillRect(12,32,t,8),e.fillStyle="#000",e.font="10px monospace",e.textAlign="left",e.fillText("KNOWLEDGE",10,28)}(),e.fillStyle="#000",e.font="16px monospace",e.textAlign="right",e.fillText("Countdown: "+s,502,20),p&&g>0&&(e.fillStyle="#000",e.font="12px monospace",e.textAlign="center",e.fillText(p,256,252)),function(){if(!y)return;let l,o,n;e.fillStyle="rgba(255, 255, 255, 0.9)",e.fillRect(0,0,t,384),e.strokeStyle="#000",e.lineWidth=4,e.strokeRect(20,40,472,304),e.fillStyle="#000",e.font="11px monospace",e.textAlign="center",m?"learn"!==m||d||(l="I have learned so much, and yet I feel\nmore mystified than before. How can I\nbridge this gap?",o="A) Try to learn faster",n="B) Meditate"):(l="Are these obstacles falling just on me?\nWhy are they keeping me away from\nthose I love? Should I fight them,\nor try to learn more about why\nthey are falling?",o="A) Fight them!",n="B) Learn about them"),l.split("\n").forEach((t,l)=>{e.fillText(t,256,80+16*l)}),e.font="bold 14px monospace",e.fillText(o,256,200),e.fillText(n,256,230),e.font="10px monospace",e.fillText("Press A or B to choose",256,280)}(),f&&(e.fillStyle="#000",e.font="32px monospace",e.textAlign="center",e.fillText("GAME OVER",256,192),e.font="16px monospace",e.fillText("Press SPACE to restart",256,222)),e.strokeStyle="#000",e.lineWidth=2,e.strokeRect(0,0,t,384),requestAnimationFrame(S)}()})();