(()=>{const e=document.getElementById("gameCanvas").getContext("2d"),t=512,l=100,o=350;let n={x:248,y:o,width:16,height:24,umbrellaOpen:!1,umbrellaOpenTime:0,power:l},i=[],r=[],a=0,h=parseInt(localStorage.getItem("umbrellaHighScore")||"0"),c=!1,f={},s=10,m=!1,y=null,d=null,u=0,p=100,x="",g=0,w=10,b=3,M=0;const S=["they seem made from strange metallic material","they have small eyes that seem to watch me","i do not know them, but they know me","their surfaces shimmer with unknown symbols","they whisper in frequencies i cannot hear","each one carries a different weight","they fall in patterns, not chaos","they avoid hitting me directly","perhaps they are trying to communicate","their texture feels impossibly smooth"];function v(){r=[];const e=Math.ceil(16);for(let t=0;t<e;t++)r.push({x:32*t,width:32,count:0,height:0,obstacles:[]})}v();const k={woman:[[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,0,1,1,0,1,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0]],umbrellaClosed:[[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0]],umbrellaOpen:[[0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,0,1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,1,0,1,1,1],[1,1,0,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,0,1,1],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0]],cat:[[0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0],[0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0],[0,0,1,1,0,0,1,1,1,1,0,0,1,1,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,1,1,0,1,1,1,1,1,1,0,1,1,0,0],[0,0,1,1,0,0,1,1,1,1,0,0,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0],[0,0,1,0,0,0,0,1,1,0,0,0,0,1,0,0],[0,0,1,1,0,1,1,1,1,1,1,0,1,1,0,0],[0,0,0,1,1,1,1,0,0,1,1,1,1,0,0,0],[0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0],[0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0],[0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0]],meteor:[[0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,1,1,1,0,1,1,1,1,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,1,1,0,1,1,1,1,0,1,1,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[1,1,1,1,0,1,1,1,1,1,1,1,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,1,1,1,1,1,0,1,1,1,1,1,1,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,0,1,1,0,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],boot:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,1,1,0,0,0,0,0,0,0,1,1,1,1,0,0],[0,1,1,0,0,0,0,0,0,0,0,1,1,1,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0]],cokeCan:[[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,0,0,0,0,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,0,1,1,1,1,0,0,0,0]]};function O(t,l,o,n=2){const i=t.length,r=t[0].length;e.fillStyle="#000";for(let a=0;a<i;a++)for(let i=0;i<r;i++)1===t[a][i]&&e.fillRect(Math.floor(l+i*n),Math.floor(o+a*n),n,n)}const A=[{sprite:k.cat,width:16,height:16,name:"cat"},{sprite:k.meteor,width:16,height:16,name:"meteor"},{sprite:k.boot,width:16,height:16,name:"boot"},{sprite:k.cokeCan,width:12,height:16,name:"can"}];function E(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function I(e){if(e.deflected)return null;let t=o;for(let l of r)for(let o of l.obstacles)if(e.x<o.x+o.width&&e.x+e.width>o.x){const l=o.y-e.height;l<t&&(t=l)}return t}function R(){document.getElementById("score").textContent=a,document.getElementById("highScore").textContent=h}window.addEventListener("keydown",e=>{if(f[e.key]=!0," "===e.key&&c&&(n.x=248,n.y=o,n.umbrellaOpen=!1,n.power=l,i=[],v(),a=0,c=!1,s=10,m=!1,y=null,d=null,u=0,x="",g=0,w=10,b=3,M=0,R()),m)return"a"===e.key||"A"===e.key?y?"learn"!==y||d||(d="faster",m=!1,u=0,b=4.5,w=15):(y="fight",m=!1,n.power=150,s=10):"b"!==e.key&&"B"!==e.key||(y?"learn"!==y||d||(d="meditate",m=!1,u=0):(y="learn",m=!1,s=10)),void e.preventDefault();["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)&&e.preventDefault()}),window.addEventListener("keyup",e=>{f[e.key]=!1}),R(),function v(){(function(){if(c)return;if(m)return;g>0&&(g--,0===g&&(x="")),"learn"===y&&!d&&u>=p&&(m=!0);const e=function(e){const t=Math.floor(e/32);return t>=0&&t<r.length?r[t].count:0}(n.x+n.width/2),v=Math.max(.15,1-.2*e);let k=!1;f.ArrowLeft&&n.x>0&&(n.x-=b*v,k=!0),f.ArrowRight&&n.x<t-n.width&&(n.x+=b*v,k=!0),"meditate"===d&&(k||n.umbrellaOpen?M=0:(M++,M>=60&&(u=Math.min(p,u+1),M=0))),f.ArrowUp&&n.power>0?(n.umbrellaOpen=!0,n.umbrellaOpenTime=10,n.power=Math.max(0,n.power-.5)):(n.umbrellaOpenTime>0?n.umbrellaOpenTime--:n.umbrellaOpen=!1,n.umbrellaOpen||(n.power=Math.min(l,n.power+.1))),n.power<=0&&(n.umbrellaOpen=!1);for(let e=i.length-1;e>=0;e--){const t=i[e];if(!t.onGround){if(t.deflected)t.velocityY+=.3,t.y+=t.velocityY,t.x+=t.velocityX,t.trail=[];else{"meteor"===t.type.name&&(t.trail.unshift({x:t.x+t.width/2,y:t.y+t.height/2}),t.trail.length>8&&t.trail.pop()),t.y+=t.velocityY,t.x+=t.velocityX;const e=I(t);if(t.y+t.height>=e){t.y=e-t.height,t.onGround=!0,t.velocityY=0,t.velocityX=0,t.trail=[];const l=Math.floor((t.x+t.width/2)/32);l>=0&&l<r.length&&(r[l].count++,r[l].obstacles.push(t),!t.deflected&&s>0&&(s++,s>10&&(s=10)))}}if(n.umbrellaOpen&&!t.deflected&&!t.onGround){const e="fight"===y?64:48,l="fight"===y?-16:-8;E(t,{x:n.x+l,y:n.y-32,width:e,height:32})&&(t.deflected=!0,t.velocityY=-8,t.velocityX=(t.x-n.x)/10,a+=10,R(),s>0&&(s--,0!==s||y||(m=!0)))}"learn"!==y||"meditate"===d||t.deflected||t.onGround||!E(t,n)||(u=Math.min(p,u+w),x=S[Math.floor(Math.random()*S.length)],g=120,t.deflected=!0,t.velocityY=-2,t.velocityX=(t.x-n.x)/20),"learn"===y&&"meditate"!==d||t.deflected||t.onGround||!E(t,n)||(c=!0,a>h&&(h=a,localStorage.setItem("umbrellaHighScore",h),document.getElementById("highScore").textContent=h)),!t.onGround&&(t.y>434||t.y<-100||t.x<-100||t.x>612)&&i.splice(e,1)}}if(n.umbrellaOpen)for(let e of r)for(let t of e.obstacles)if(!t.pushing&&E(n,{x:n.x-20,y:n.y,width:n.width+40,height:n.height})){const e=n.x+n.width/2<t.x+t.width/2?1:-1;t.pushVelocityX=2*e,t.pushing=!0}for(let e of r)for(let l=e.obstacles.length-1;l>=0;l--){const o=e.obstacles[l];if(o.pushVelocityX){if(o.x+=o.pushVelocityX,o.pushVelocityX*=.95,Math.abs(o.pushVelocityX)<.1&&(o.pushVelocityX=0,o.pushing=!1),o.x<-o.width||o.x>t){e.obstacles.splice(l,1),e.count--;const t=i.indexOf(o);-1!==t&&i.splice(t,1);continue}const n=Math.floor((o.x+o.width/2)/32);n!==r.indexOf(e)&&n>=0&&n<r.length&&(e.obstacles.splice(l,1),e.count--,r[n].obstacles.push(o),r[n].count++)}}Math.random()<.02&&i.push(function(){const e=A[Math.floor(Math.random()*A.length)],l={x:Math.random()*(t-2*e.width),y:2*-e.height,width:2*e.width,height:2*e.height,velocityY:2+1*Math.random(),velocityX:0,type:e,deflected:!1,onGround:!1,trail:[]};if("meteor"===e.name){const o=Math.random()*Math.PI/3-Math.PI/6;l.velocityX=3*Math.sin(o),l.velocityY=3*Math.cos(o),l.velocityX<0?l.x=t+2*e.width:l.velocityX>0&&(l.x=2*-e.width)}return l}());for(let e of r)if(e.count>0&&o-32*e.count<=50){c=!0,a>h&&(h=a,localStorage.setItem("umbrellaHighScore",h),document.getElementById("highScore").textContent=h);break}})(),e.fillStyle="#fff",e.fillRect(0,0,t,384),r.forEach(e=>{e.obstacles.forEach(e=>{O(e.type.sprite,e.x,e.y)})}),i.forEach(t=>{t.onGround||function(t){if("meteor"===t.type.name&&!t.onGround&&t.trail.length>0){e.fillStyle="#000";for(let l=0;l<t.trail.length;l++){const o=t.trail[l],n=(t.trail.length,Math.max(1,4-l));for(let t=0;t<n;t++)for(let l=0;l<n;l++)Math.random()>.3&&e.fillRect(o.x+t,o.y+l,1,1)}}O(t.type.sprite,t.x,t.y)}(t)}),function(){if(O(k.woman,n.x,n.y),n.umbrellaOpen)if("fight"===y){const e=3;O(k.umbrellaOpen,n.x-16,n.y-40,e)}else O(k.umbrellaOpen,n.x-8,n.y-32);else O(k.umbrellaClosed,n.x+12,n.y+4)}(),function(){const t="fight"===y?150:100;e.strokeStyle="#000",e.lineWidth=2,e.strokeRect(10,10,t,12),e.fillStyle="#fff",e.fillRect(12,12,t-4,8);const o="fight"===y?150:l,i=Math.max(0,n.power/o*(t-4));e.fillStyle="#000",e.fillRect(12,12,i,8),e.fillStyle="#000",e.font="10px monospace",e.textAlign="left",e.fillText("POWER",10,8)}(),function(){if("learn"!==y)return;e.strokeStyle="#000",e.lineWidth=2,e.strokeRect(10,30,100,12),e.fillStyle="#fff",e.fillRect(12,32,96,8);const t=Math.max(0,u/p*96);e.fillStyle="#000",e.fillRect(12,32,t,8),e.fillStyle="#000",e.font="10px monospace",e.textAlign="left",e.fillText("KNOWLEDGE",10,28)}(),e.fillStyle="#000",e.font="16px monospace",e.textAlign="right",e.fillText("Countdown: "+s,502,20),x&&g>0&&(e.fillStyle="#000",e.font="12px monospace",e.textAlign="center",e.fillText(x,256,252)),function(){if(!m)return;let l,o,n;e.fillStyle="rgba(255, 255, 255, 0.9)",e.fillRect(0,0,t,384),e.strokeStyle="#000",e.lineWidth=4,e.strokeRect(20,40,472,304),e.fillStyle="#000",e.font="11px monospace",e.textAlign="center",y?"learn"!==y||d||(l="I have learned so much, and yet I feel\nmore mystified than before. How can I\nbridge this gap?",o="A) Try to learn faster",n="B) Meditate"):(l="Are these obstacles falling just on me?\nWhy are they keeping me away from\nthose I love? Should I fight them,\nor try to learn more about why\nthey are falling?",o="A) Fight them!",n="B) Learn about them"),l.split("\n").forEach((t,l)=>{e.fillText(t,256,80+16*l)}),e.font="bold 14px monospace",e.fillText(o,256,200),e.fillText(n,256,230),e.font="10px monospace",e.fillText("Press A or B to choose",256,280)}(),c&&(e.fillStyle="#000",e.font="32px monospace",e.textAlign="center",e.fillText("GAME OVER",256,192),e.font="16px monospace",e.fillText("Press SPACE to restart",256,222)),e.strokeStyle="#000",e.lineWidth=2,e.strokeRect(0,0,t,384),requestAnimationFrame(v)}()})();