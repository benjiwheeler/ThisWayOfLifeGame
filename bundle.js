(()=>{const e=document.getElementById("gameCanvas").getContext("2d"),t=512,l=100,o=350,n=32;let i={x:248,y:o,width:16,height:24,umbrellaOpen:!1,umbrellaOpenTime:0,power:l},r=[],a=[],h=0,c=parseInt(localStorage.getItem("umbrellaHighScore")||"0"),f=!1,s={},y=10,m=!1,u=null,d=null,p=0,x=100,g="",w=0,b=10,M=3,v=0;const S=["they seem made from strange metallic material","they have small eyes that seem to watch me","i do not know them, but they know me","their surfaces shimmer with unknown symbols","they whisper in frequencies i cannot hear","each one carries a different weight","they fall in patterns, not chaos","they avoid hitting me directly","perhaps they are trying to communicate","their texture feels impossibly smooth"];function k(){a=[];const e=Math.ceil(16);for(let t=0;t<e;t++)a.push({x:t*n,width:n,count:0,height:0,obstacles:[]})}k();const O={woman:[[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,0,1,1,0,1,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0]],umbrellaClosed:[[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0]],umbrellaOpen:[[0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,0,1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,1,0,1,1,1],[1,1,0,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,0,1,1],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0]],cat:[[0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0],[0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0],[0,0,1,1,0,0,1,1,1,1,0,0,1,1,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,1,1,0,1,1,1,1,1,1,0,1,1,0,0],[0,0,1,1,0,0,1,1,1,1,0,0,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0],[0,0,1,0,0,0,0,1,1,0,0,0,0,1,0,0],[0,0,1,1,0,1,1,1,1,1,1,0,1,1,0,0],[0,0,0,1,1,1,1,0,0,1,1,1,1,0,0,0],[0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0],[0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0],[0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0]],meteor:[[0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,1,1,1,0,1,1,1,1,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,1,1,0,1,1,1,1,0,1,1,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[1,1,1,1,0,1,1,1,1,1,1,1,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,1,1,1,1,1,0,1,1,1,1,1,1,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,0,1,1,0,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],boot:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,1,1,0,0,0,0,0,0,0,1,1,1,1,0,0],[0,1,1,0,0,0,0,0,0,0,0,1,1,1,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0]],cokeCan:[[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,0,0,0,0,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,0,1,1,1,1,0,0,0,0]]};function A(t,l,o,n=2){const i=t.length,r=t[0].length;e.fillStyle="#000";for(let a=0;a<i;a++)for(let i=0;i<r;i++)1===t[a][i]&&e.fillRect(Math.floor(l+i*n),Math.floor(o+a*n),n,n)}const E=[{sprite:O.cat,width:16,height:16,name:"cat"},{sprite:O.meteor,width:16,height:16,name:"meteor"},{sprite:O.boot,width:16,height:16,name:"boot"},{sprite:O.cokeCan,width:12,height:16,name:"can"}];function I(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function R(e){if(e.deflected)return null;for(let t of a)for(let l of t.obstacles)if(I(e,l))return l;return null}function X(e,t){let l=o;for(let o of a)for(let n of o.obstacles)e<n.x+n.width&&e+t>n.x&&(l=Math.min(l,n.y));return l}function T(){document.getElementById("score").textContent=h,document.getElementById("highScore").textContent=c}window.addEventListener("keydown",e=>{if(s[e.key]=!0," "===e.key&&f&&(i.x=248,i.y=o,i.umbrellaOpen=!1,i.power=l,r=[],k(),h=0,f=!1,y=10,m=!1,u=null,d=null,p=0,g="",w=0,b=10,M=3,v=0,T()),m)return"a"===e.key||"A"===e.key?u?"learn"!==u||d||(d="faster",m=!1,p=0,M=4.5,b=15):(u="fight",m=!1,i.power=150,y=10):"b"!==e.key&&"B"!==e.key||(u?"learn"!==u||d||(d="meditate",m=!1,p=0):(u="learn",m=!1,y=10)),void e.preventDefault();["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)&&e.preventDefault()}),window.addEventListener("keyup",e=>{s[e.key]=!1}),T(),function k(){(function(){if(f)return;if(m)return;w>0&&(w--,0===w&&(g="")),"learn"===u&&!d&&p>=x&&(m=!0);const e=function(e){const t=Math.floor(e/n);return t>=0&&t<a.length?a[t].count:0}(i.x+i.width/2),k=Math.max(.15,1-.2*e);let O=!1;s.ArrowLeft&&i.x>0&&(i.x-=M*k,O=!0),s.ArrowRight&&i.x<t-i.width&&(i.x+=M*k,O=!0),"meditate"===d&&(O||i.umbrellaOpen?v=0:(v++,v>=60&&(p=Math.min(x,p+1),v=0))),s.ArrowUp&&i.power>0?(i.umbrellaOpen=!0,i.umbrellaOpenTime=10,i.power=Math.max(0,i.power-.5)):(i.umbrellaOpenTime>0?i.umbrellaOpenTime--:i.umbrellaOpen=!1,i.umbrellaOpen||(i.power=Math.min(l,i.power+.1))),i.power<=0&&(i.umbrellaOpen=!1);for(let e=r.length-1;e>=0;e--){const t=r[e];if(!t.onGround){if(t.deflected)t.velocityY+=.3,t.y+=t.velocityY,t.x+=t.velocityX,t.trail=[];else{"meteor"===t.type.name&&(t.trail.unshift({x:t.x+t.width/2,y:t.y+t.height/2}),t.trail.length>8&&t.trail.pop()),t.y+=t.velocityY,t.x+=t.velocityX;const e=R(t);if(e){t.y=e.y-t.height,t.onGround=!0,t.velocityY=0,t.velocityX=0,t.trail=[];const l=Math.floor((t.x+t.width/2)/n);if(l>=0&&l<a.length){const e=a[l];e.count++,e.obstacles.push(t)}}}if(i.umbrellaOpen&&!t.deflected&&!t.onGround){const e="fight"===u?64:48,l="fight"===u?-16:-8;I(t,{x:i.x+l,y:i.y-32,width:e,height:32})&&(t.deflected=!0,t.velocityY=-8,t.velocityX=(t.x-i.x)/10,h+=10,T(),y>0&&(y--,0!==y||u||(m=!0)))}if("learn"!==u||"meditate"===d||t.deflected||t.onGround||!I(t,i)||(p=Math.min(x,p+b),g=S[Math.floor(Math.random()*S.length)],w=120,t.deflected=!0,t.velocityY=-2,t.velocityX=(t.x-i.x)/20),"learn"===u&&"meditate"!==d||t.deflected||t.onGround||!I(t,i)||(f=!0,h>c&&(c=h,localStorage.setItem("umbrellaHighScore",c),document.getElementById("highScore").textContent=c)),t.y+t.height>=o&&!t.onGround){t.onGround=!0,t.velocityY=0,t.velocityX=0,t.y=o-t.height,t.trail=[];const e=Math.floor((t.x+t.width/2)/n);if(e>=0&&e<a.length){const l=a[e];l.count++,l.obstacles.push(t),!t.deflected&&y>0&&(y++,y>10&&(y=10))}}!t.onGround&&(t.y>434||t.y<-100||t.x<-100||t.x>612)&&r.splice(e,1)}}if(i.umbrellaOpen)for(let e of a)for(let t of e.obstacles)if(!t.pushing&&I(i,{x:i.x-20,y:i.y,width:i.width+40,height:i.height})){const e=i.x+i.width/2<t.x+t.width/2?1:-1;t.pushVelocityX=2*e,t.pushing=!0}for(let e of a)for(let l=e.obstacles.length-1;l>=0;l--){const o=e.obstacles[l];if(o.pushVelocityX){if(o.x+=o.pushVelocityX,o.pushVelocityX*=.95,Math.abs(o.pushVelocityX)<.1&&(o.pushVelocityX=0,o.pushing=!1),o.x<-o.width||o.x>t){e.obstacles.splice(l,1),e.count--;const t=r.indexOf(o);-1!==t&&r.splice(t,1);continue}const i=Math.floor((o.x+o.width/2)/n);i!==a.indexOf(e)&&i>=0&&i<a.length&&(e.obstacles.splice(l,1),e.count--,a[i].obstacles.push(o),a[i].count++)}if(!o.pushing){const e=X(o.x,o.width)-o.height;o.y<e-2?(o.y+=3,o.y>=e&&(o.y=e)):(o.y,o.y=e)}}Math.random()<.02&&r.push(function(){const e=E[Math.floor(Math.random()*E.length)],l={x:Math.random()*(t-2*e.width),y:2*-e.height,width:2*e.width,height:2*e.height,velocityY:2+1*Math.random(),velocityX:0,type:e,deflected:!1,onGround:!1,trail:[]};if("meteor"===e.name){const o=Math.random()*Math.PI/3-Math.PI/6;l.velocityX=3*Math.sin(o),l.velocityY=3*Math.cos(o),l.velocityX<0?l.x=t+2*e.width:l.velocityX>0&&(l.x=2*-e.width)}return l}());for(let e of a)if(e.count>0&&o-32*e.count<=50){f=!0,h>c&&(c=h,localStorage.setItem("umbrellaHighScore",c),document.getElementById("highScore").textContent=c);break}})(),e.fillStyle="#fff",e.fillRect(0,0,t,384),a.forEach(e=>{e.obstacles.forEach(e=>{A(e.type.sprite,e.x,e.y)})}),r.forEach(t=>{t.onGround||function(t){if("meteor"===t.type.name&&!t.onGround&&t.trail.length>0){e.fillStyle="#000";for(let l=0;l<t.trail.length;l++){const o=t.trail[l],n=(t.trail.length,Math.max(1,4-l));for(let t=0;t<n;t++)for(let l=0;l<n;l++)Math.random()>.3&&e.fillRect(o.x+t,o.y+l,1,1)}}A(t.type.sprite,t.x,t.y)}(t)}),function(){if(A(O.woman,i.x,i.y),i.umbrellaOpen)if("fight"===u){const e=3;A(O.umbrellaOpen,i.x-16,i.y-40,e)}else A(O.umbrellaOpen,i.x-8,i.y-32);else A(O.umbrellaClosed,i.x+12,i.y+4)}(),function(){const t="fight"===u?150:100;e.strokeStyle="#000",e.lineWidth=2,e.strokeRect(10,10,t,12),e.fillStyle="#fff",e.fillRect(12,12,t-4,8);const o="fight"===u?150:l,n=Math.max(0,i.power/o*(t-4));e.fillStyle="#000",e.fillRect(12,12,n,8),e.fillStyle="#000",e.font="10px monospace",e.textAlign="left",e.fillText("POWER",10,8)}(),function(){if("learn"!==u)return;e.strokeStyle="#000",e.lineWidth=2,e.strokeRect(10,30,100,12),e.fillStyle="#fff",e.fillRect(12,32,96,8);const t=Math.max(0,p/x*96);e.fillStyle="#000",e.fillRect(12,32,t,8),e.fillStyle="#000",e.font="10px monospace",e.textAlign="left",e.fillText("KNOWLEDGE",10,28)}(),e.fillStyle="#000",e.font="16px monospace",e.textAlign="right",e.fillText("Countdown: "+y,502,20),g&&w>0&&(e.fillStyle="#000",e.font="12px monospace",e.textAlign="center",e.fillText(g,256,252)),function(){if(!m)return;let l,o,n;e.fillStyle="rgba(255, 255, 255, 0.9)",e.fillRect(0,0,t,384),e.strokeStyle="#000",e.lineWidth=4,e.strokeRect(20,40,472,304),e.fillStyle="#000",e.font="11px monospace",e.textAlign="center",u?"learn"!==u||d||(l="I have learned so much, and yet I feel\nmore mystified than before. How can I\nbridge this gap?",o="A) Try to learn faster",n="B) Meditate"):(l="Are these obstacles falling just on me?\nWhy are they keeping me away from\nthose I love? Should I fight them,\nor try to learn more about why\nthey are falling?",o="A) Fight them!",n="B) Learn about them"),l.split("\n").forEach((t,l)=>{e.fillText(t,256,80+16*l)}),e.font="bold 14px monospace",e.fillText(o,256,200),e.fillText(n,256,230),e.font="10px monospace",e.fillText("Press A or B to choose",256,280)}(),f&&(e.fillStyle="#000",e.font="32px monospace",e.textAlign="center",e.fillText("GAME OVER",256,192),e.font="16px monospace",e.fillText("Press SPACE to restart",256,222)),e.strokeStyle="#000",e.lineWidth=2,e.strokeRect(0,0,t,384),requestAnimationFrame(k)}()})();