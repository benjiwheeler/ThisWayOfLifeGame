(()=>{const e=document.getElementById("gameCanvas").getContext("2d"),t=512,o=100,l=350;let n={x:248,y:l,width:16,height:24,umbrellaOpen:!1,umbrellaOpenTime:0,power:o},i=[],r=[],h=0,a=parseInt(localStorage.getItem("umbrellaHighScore")||"0"),f=!1,c={},s=10,y=!1,m=null,d=null,u=0,x=100,p="",g=0,w=10,b=3,M=0;const S=["they seem made from strange metallic material","they have small eyes that seem to watch me","i do not know them, but they know me","their surfaces shimmer with unknown symbols","they whisper in frequencies i cannot hear","each one carries a different weight","they fall in patterns, not chaos","they avoid hitting me directly","perhaps they are trying to communicate","their texture feels impossibly smooth"];function k(){r=[];const e=Math.ceil(16);for(let t=0;t<e;t++)r.push({x:32*t,width:32,count:0,height:0,obstacles:[]})}k();const v={woman:[[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,0,1,1,0,1,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0]],umbrellaClosed:[[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0]],umbrellaOpen:[[0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,0,1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,1,0,1,1,1],[1,1,0,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,0,1,1],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0]],cat:[[0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0],[0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0],[0,0,1,1,0,0,1,1,1,1,0,0,1,1,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,1,1,0,1,1,1,1,1,1,0,1,1,0,0],[0,0,1,1,0,0,1,1,1,1,0,0,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0],[0,0,1,0,0,0,0,1,1,0,0,0,0,1,0,0],[0,0,1,1,0,1,1,1,1,1,1,0,1,1,0,0],[0,0,0,1,1,1,1,0,0,1,1,1,1,0,0,0],[0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0],[0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0],[0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0]],meteor:[[0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,1,1,1,0,1,1,1,1,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,1,1,0,1,1,1,1,0,1,1,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[1,1,1,1,0,1,1,1,1,1,1,1,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,1,1,1,1,1,0,1,1,1,1,1,1,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,0,1,1,0,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],boot:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,1,1,0,0,0,0,0,0,0,1,1,1,1,0,0],[0,1,1,0,0,0,0,0,0,0,0,1,1,1,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0]],cokeCan:[[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,0,0,0,0,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,0,1,1,1,1,0,0,0,0]]};function O(t,o,l,n=2){const i=t.length,r=t[0].length;e.fillStyle="#000";for(let h=0;h<i;h++)for(let i=0;i<r;i++)1===t[h][i]&&e.fillRect(Math.floor(o+i*n),Math.floor(l+h*n),n,n)}const A=[{sprite:v.cat,width:16,height:16,name:"cat"},{sprite:v.meteor,width:16,height:16,name:"meteor"},{sprite:v.boot,width:16,height:16,name:"boot"},{sprite:v.cokeCan,width:12,height:16,name:"can"}];function E(e,t,o,l=2){const n=Math.floor(o/l),i=Math.floor(t/l);return!(n<0||n>=e.length||i<0||i>=e[0].length||1!==e[n][i])}function I(e,t,o=2,l=2){if(e.x>=t.x+t.width||e.x+e.width<=t.x||e.y>=t.y+t.height||e.y+e.height<=t.y)return!1;const n=Math.max(e.x,t.x),i=Math.min(e.x+e.width,t.x+t.width),r=Math.max(e.y,t.y),h=Math.min(e.y+e.height,t.y+t.height);for(let a=r;a<h;a+=2)for(let r=n;r<i;r+=2){const n=r-e.x,i=a-e.y,h=r-t.x,f=a-t.y,c=e.type?e.type.sprite:v.woman,s=t.type?t.type.sprite:v.woman;if(E(c,n,i,o)&&E(s,h,f,l))return!0}return!1}function R(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function T(e){if(e.deflected)return null;let t=l;for(let o of r)for(let l of o.obstacles)if(e.x<l.x+l.width&&e.x+e.width>l.x){l.y,e.height;let o=!1;const n=Math.max(e.x,l.x),i=Math.min(e.x+e.width,l.x+l.width);for(let t=n;t<i;t+=4){const n=t-e.x,i=t-l.x;let r=!1,h=!1;for(let t=e.height-8;t<e.height;t+=2)if(E(e.type.sprite,n,t,2)){r=!0;break}for(let e=0;e<8;e+=2)if(E(l.type.sprite,i,e,2)){h=!0;break}if(r&&h){o=!0;break}}if(o){const o=l.y-e.height;o<t&&(t=o)}}return t}function X(){document.getElementById("score").textContent=h,document.getElementById("highScore").textContent=a}window.addEventListener("keydown",e=>{if(c[e.key]=!0," "===e.key&&f&&(n.x=248,n.y=l,n.umbrellaOpen=!1,n.power=o,i=[],k(),h=0,f=!1,s=10,y=!1,m=null,d=null,u=0,p="",g=0,w=10,b=3,M=0,X()),y)return"a"===e.key||"A"===e.key?m?"learn"!==m||d||(d="faster",y=!1,u=0,b=4.5,w=15):(m="fight",y=!1,n.power=150,s=10):"b"!==e.key&&"B"!==e.key||(m?"learn"!==m||d||(d="meditate",y=!1,u=0):(m="learn",y=!1,s=10)),void e.preventDefault();["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)&&e.preventDefault()}),window.addEventListener("keyup",e=>{c[e.key]=!1}),X(),document.getElementById("version").textContent="1.1",function k(){(function(){if(f)return;if(y)return;g>0&&(g--,0===g&&(p="")),"learn"===m&&!d&&u>=x&&(y=!0);const e=function(e){const t=Math.floor(e/32);return t>=0&&t<r.length?r[t].count:0}(n.x+n.width/2),k=Math.max(.15,1-.2*e);let v=!1;c.ArrowLeft&&n.x>0&&(n.x-=b*k,v=!0),c.ArrowRight&&n.x<t-n.width&&(n.x+=b*k,v=!0),"meditate"===d&&(v||n.umbrellaOpen?M=0:(M++,M>=60&&(u=Math.min(x,u+1),M=0))),c.ArrowUp&&n.power>0?(n.umbrellaOpen=!0,n.umbrellaOpenTime=10,n.power=Math.max(0,n.power-.5)):(n.umbrellaOpenTime>0?n.umbrellaOpenTime--:n.umbrellaOpen=!1,n.umbrellaOpen||(n.power=Math.min(o,n.power+.1))),n.power<=0&&(n.umbrellaOpen=!1);for(let e=i.length-1;e>=0;e--){const t=i[e];if(!t.onGround){if(t.deflected)t.velocityY+=.3,t.y+=t.velocityY,t.x+=t.velocityX,t.trail=[];else{"meteor"===t.type.name&&(t.trail.unshift({x:t.x+t.width/2,y:t.y+t.height/2}),t.trail.length>8&&t.trail.pop()),t.y+=t.velocityY,t.x+=t.velocityX;const e=T(t);if(t.y+t.height>=e){t.y=e-t.height,t.onGround=!0,t.velocityY=0,t.velocityX=0,t.trail=[];const o=Math.floor((t.x+t.width/2)/32);o>=0&&o<r.length&&(r[o].count++,r[o].obstacles.push(t),!t.deflected&&s>0&&(s++,s>10&&(s=10)))}}if(n.umbrellaOpen&&!t.deflected&&!t.onGround){const e="fight"===m?64:48,o="fight"===m?-16:-8;R(t,{x:n.x+o,y:n.y-32,width:e,height:32})&&(t.deflected=!0,t.velocityY=-8,t.velocityX=(t.x-n.x)/10,h+=10,X(),s>0&&(s--,0!==s||m||(y=!0)))}"learn"!==m||"meditate"===d||t.deflected||t.onGround||!I(t,n)||(u=Math.min(x,u+w),p=S[Math.floor(Math.random()*S.length)],g=120,t.deflected=!0,t.velocityY=-2,t.velocityX=(t.x-n.x)/20),"learn"===m&&"meditate"!==d||t.deflected||t.onGround||!I(t,n)||(f=!0,h>a&&(a=h,localStorage.setItem("umbrellaHighScore",a),document.getElementById("highScore").textContent=a)),!t.onGround&&(t.y>434||t.y<-100||t.x<-100||t.x>612)&&i.splice(e,1)}}if(n.umbrellaOpen)for(let e of r)for(let t of e.obstacles)if(!t.pushing&&R(n,{x:n.x-20,y:n.y,width:n.width+40,height:n.height})){const e=n.x+n.width/2<t.x+t.width/2?1:-1;t.pushVelocityX=2*e,t.pushing=!0}for(let e of r)for(let o=e.obstacles.length-1;o>=0;o--){const l=e.obstacles[o];if(l.pushVelocityX){if(l.x+=l.pushVelocityX,l.pushVelocityX*=.95,Math.abs(l.pushVelocityX)<.1&&(l.pushVelocityX=0,l.pushing=!1),l.x<-l.width||l.x>t){e.obstacles.splice(o,1),e.count--;const t=i.indexOf(l);-1!==t&&i.splice(t,1);continue}const n=Math.floor((l.x+l.width/2)/32);n!==r.indexOf(e)&&n>=0&&n<r.length&&(e.obstacles.splice(o,1),e.count--,r[n].obstacles.push(l),r[n].count++)}}Math.random()<.02&&i.push(function(){const e=A[Math.floor(Math.random()*A.length)],o={x:Math.random()*(t-2*e.width),y:2*-e.height,width:2*e.width,height:2*e.height,velocityY:2+1*Math.random(),velocityX:0,type:e,deflected:!1,onGround:!1,trail:[]};if("meteor"===e.name){const l=Math.random()*Math.PI/3-Math.PI/6;o.velocityX=3*Math.sin(l),o.velocityY=3*Math.cos(l),o.velocityX<0?o.x=t+2*e.width:o.velocityX>0&&(o.x=2*-e.width)}return o}());for(let e of r)if(e.count>0&&l-32*e.count<=50){f=!0,h>a&&(a=h,localStorage.setItem("umbrellaHighScore",a),document.getElementById("highScore").textContent=a);break}})(),e.fillStyle="#fff",e.fillRect(0,0,t,384),r.forEach(e=>{e.obstacles.forEach(e=>{O(e.type.sprite,e.x,e.y)})}),i.forEach(t=>{t.onGround||function(t){if("meteor"===t.type.name&&!t.onGround&&t.trail.length>0){e.fillStyle="#000";for(let o=0;o<t.trail.length;o++){const l=t.trail[o],n=(t.trail.length,Math.max(1,4-o));for(let t=0;t<n;t++)for(let o=0;o<n;o++)Math.random()>.3&&e.fillRect(l.x+t,l.y+o,1,1)}}O(t.type.sprite,t.x,t.y)}(t)}),function(){if(O(v.woman,n.x,n.y),n.umbrellaOpen)if("fight"===m){const e=3;O(v.umbrellaOpen,n.x-16,n.y-40,e)}else O(v.umbrellaOpen,n.x-8,n.y-32);else O(v.umbrellaClosed,n.x+12,n.y+4)}(),function(){const t="fight"===m?150:100;e.strokeStyle="#000",e.lineWidth=2,e.strokeRect(10,10,t,12),e.fillStyle="#fff",e.fillRect(12,12,t-4,8);const l="fight"===m?150:o,i=Math.max(0,n.power/l*(t-4));e.fillStyle="#000",e.fillRect(12,12,i,8),e.fillStyle="#000",e.font="10px monospace",e.textAlign="left",e.fillText("POWER",10,8)}(),function(){if("learn"!==m)return;e.strokeStyle="#000",e.lineWidth=2,e.strokeRect(10,30,100,12),e.fillStyle="#fff",e.fillRect(12,32,96,8);const t=Math.max(0,u/x*96);e.fillStyle="#000",e.fillRect(12,32,t,8),e.fillStyle="#000",e.font="10px monospace",e.textAlign="left",e.fillText("KNOWLEDGE",10,28)}(),e.fillStyle="#000",e.font="16px monospace",e.textAlign="right",e.fillText("Countdown: "+s,502,20),p&&g>0&&(e.fillStyle="#000",e.font="12px monospace",e.textAlign="center",e.fillText(p,256,252)),function(){if(!y)return;let o,l,n;e.fillStyle="rgba(255, 255, 255, 0.9)",e.fillRect(0,0,t,384),e.strokeStyle="#000",e.lineWidth=4,e.strokeRect(20,40,472,304),e.fillStyle="#000",e.font="11px monospace",e.textAlign="center",m?"learn"!==m||d||(o="I have learned so much, and yet I feel\nmore mystified than before. How can I\nbridge this gap?",l="A) Try to learn faster",n="B) Meditate"):(o="Are these obstacles falling just on me?\nWhy are they keeping me away from\nthose I love? Should I fight them,\nor try to learn more about why\nthey are falling?",l="A) Fight them!",n="B) Learn about them"),o.split("\n").forEach((t,o)=>{e.fillText(t,256,80+16*o)}),e.font="bold 14px monospace",e.fillText(l,256,200),e.fillText(n,256,230),e.font="10px monospace",e.fillText("Press A or B to choose",256,280)}(),f&&(e.fillStyle="#000",e.font="32px monospace",e.textAlign="center",e.fillText("GAME OVER",256,192),e.font="16px monospace",e.fillText("Press SPACE to restart",256,222)),e.strokeStyle="#000",e.lineWidth=2,e.strokeRect(0,0,t,384),requestAnimationFrame(k)}()})();