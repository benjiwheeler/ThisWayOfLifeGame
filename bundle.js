(()=>{const t=document.getElementById("gameCanvas").getContext("2d"),e=512,l=100,o=350;let n={x:248,y:o,width:16,height:24,umbrellaOpen:!1,umbrellaOpenTime:0,power:l},i=[],r=[],a=0,h=parseInt(localStorage.getItem("umbrellaHighScore")||"0"),f=!1,c={},s=10,y=!1,m=null,d=null,u=0,x=100,p="",g=0,w=10,b=3,M=0,v=0,S=1,k=1;const O=["they seem made from strange metallic material","they have small eyes that seem to watch me","i do not know them, but they know me","their surfaces shimmer with unknown symbols","they whisper in frequencies i cannot hear","each one carries a different weight","they fall in patterns, not chaos","they avoid hitting me directly","perhaps they are trying to communicate","their texture feels impossibly smooth"];function A(){r=[];const t=Math.ceil(16);for(let e=0;e<t;e++)r.push({x:32*e,width:32,count:0,height:0,obstacles:[]})}A();const X={woman:[[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,0,1,1,0,1,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0]],umbrellaClosed:[[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0]],umbrellaOpen:[[0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,0,1,1,0,1,1,0,1,1,1,1,0,1,1,0,1,1,0,1,1,1],[1,1,0,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,0,1,1],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0,0,0,0,0]],cat:[[0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0],[0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0],[0,0,1,1,0,0,1,1,1,1,0,0,1,1,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,0,1,1,0,1,1,1,1,1,1,0,1,1,0,0],[0,0,1,1,0,0,1,1,1,1,0,0,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0],[0,0,1,0,0,0,0,1,1,0,0,0,0,1,0,0],[0,0,1,1,0,1,1,1,1,1,1,0,1,1,0,0],[0,0,0,1,1,1,1,0,0,1,1,1,1,0,0,0],[0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0],[0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0],[0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0]],meteor:[[0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,1,1,1,0,1,1,1,1,0,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,1,1,0,1,1,1,1,0,1,1,0,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[1,1,1,1,0,1,1,1,1,1,1,1,0,0,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,1,1,1,1,1,0,1,1,1,1,1,1,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,0,1,1,0,1,1,1,1,1,0,0,0,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0],[0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],boot:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0],[0,1,1,0,0,0,0,0,0,0,1,1,1,1,0,0],[0,1,1,0,0,0,0,0,0,0,0,1,1,1,0,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0]],cokeCan:[[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,1,1,1,1,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,0,0,0,0,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,1,1,1,1,1,1,0,0,0],[0,0,0,0,1,1,1,1,0,0,0,0]]};function E(e,l,o,n=2){const i=e.length,r=e[0].length;t.fillStyle="#000";for(let a=0;a<i;a++)for(let i=0;i<r;i++)1===e[a][i]&&t.fillRect(Math.floor(l+i*n),Math.floor(o+a*n),n,n)}const I=[{sprite:X.cat,width:16,height:16,name:"cat"},{sprite:X.meteor,width:16,height:16,name:"meteor"},{sprite:X.boot,width:16,height:16,name:"boot"},{sprite:X.cokeCan,width:12,height:16,name:"can"}];function R(t,e,l,o=2){const n=Math.floor(l/o),i=Math.floor(e/o);return!(n<0||n>=t.length||i<0||i>=t[0].length||1!==t[n][i])}function T(t,e,l=2,o=2){if(t.x>=e.x+e.width||t.x+t.width<=e.x||t.y>=e.y+e.height||t.y+t.height<=e.y)return!1;const n=Math.max(t.x,e.x),i=Math.min(t.x+t.width,e.x+e.width),r=Math.max(t.y,e.y),a=Math.min(t.y+t.height,e.y+e.height);for(let h=r;h<a;h+=2)for(let r=n;r<i;r+=2){const n=r-t.x,i=h-t.y,a=r-e.x,f=h-e.y,c=t.type?t.type.sprite:X.woman,s=e.type?e.type.sprite:X.woman;if(R(c,n,i,l)&&R(s,a,f,o))return!0}return!1}function V(t,e){return t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.y+t.height>e.y}function C(t,e=!1){if(t.deflected)return null;let l=o;for(let o of r)for(let n of o.obstacles){if(e&&n===t)continue;if(!(t.x<n.x+n.width&&t.x+t.width>n.x))continue;const o=Math.max(t.x,n.x),i=Math.min(t.x+t.width,n.x+n.width);for(let e=o;e<i;e+=2){const o=e-t.x,i=e-n.x;let r=-1;for(let e=t.height-1;e>=0;e--)if(R(t.type.sprite,o,e,2)){r=e;break}if(-1===r)continue;let a=-1;for(let t=0;t<n.height;t++)if(R(n.type.sprite,i,t,2)){a=t;break}if(-1===a)continue;const h=n.y+a-(r+1);h<l&&(l=h)}}return l}function Y(){document.getElementById("score").textContent=a,document.getElementById("highScore").textContent=h}window.addEventListener("keydown",t=>{if(c[t.key]=!0," "===t.key&&f&&(n.x=248,n.y=o,n.umbrellaOpen=!1,n.power=l,i=[],A(),a=0,f=!1,s=10,y=!1,m=null,d=null,u=0,p="",g=0,w=10,b=3,M=0,v=0,S=1,k=1,Y()),y)return"a"===t.key||"A"===t.key?m?"learn"!==m||d||(d="faster",y=!1,u=0,b=4.5,w=15):(m="fight",y=!1,n.power=150,s=10):"b"!==t.key&&"B"!==t.key||(m?"learn"!==m||d||(d="meditate",y=!1,u=0):(m="learn",y=!1,s=10)),void t.preventDefault();["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(t.key)&&t.preventDefault()}),window.addEventListener("keyup",t=>{c[t.key]=!1}),Y(),document.getElementById("version").textContent="1.9",function A(){(function(){if(f)return;if(y)return;g>0&&(g--,0===g&&(p="")),"learn"===m&&!d&&u>=x&&(y=!0),"fight"===m&&(v++,S=Math.min(2.5,1+v/3600),k=Math.min(3,1+v/3600));const t=function(t){const e=Math.floor(t/32);return e>=0&&e<r.length?r[e].count:0}(n.x+n.width/2),A=Math.max(.15,1-.2*t);let E=!1;c.ArrowLeft&&n.x>0&&(n.x-=b*A,E=!0),c.ArrowRight&&n.x<e-n.width&&(n.x+=b*A,E=!0),"meditate"===d&&(E||n.umbrellaOpen?M=0:(M++,M>=15&&(u=Math.min(x,u+1),M=0))),c.ArrowUp&&n.power>0?(n.umbrellaOpen=!0,n.umbrellaOpenTime=10,n.power=Math.max(0,n.power-.5)):(n.umbrellaOpenTime>0?n.umbrellaOpenTime--:n.umbrellaOpen=!1,n.umbrellaOpen||(n.power=Math.min(l,n.power+.1))),n.power<=0&&(n.umbrellaOpen=!1);for(let t=i.length-1;t>=0;t--){const e=i[t];if(!e.onGround){if(e.deflected)e.velocityY+=.3,e.y+=e.velocityY,e.x+=e.velocityX,e.trail=[];else{"meteor"===e.type.name&&(e.trail.unshift({x:e.x+e.width/2,y:e.y+e.height/2}),e.trail.length>8&&e.trail.pop()),e.y+=e.velocityY,e.x+=e.velocityX;const t=C(e);if(e.y>=t){e.y=t,e.onGround=!0,e.velocityY=0,e.velocityX=0,e.trail=[];const l=Math.floor((e.x+e.width/2)/32);l>=0&&l<r.length&&(r[l].count++,r[l].obstacles.push(e),!e.deflected&&s>0&&(s++,s>10&&(s=10)))}}if(n.umbrellaOpen&&!e.deflected&&!e.onGround){const t="fight"===m?64:48,l="fight"===m?-16:-8;V(e,{x:n.x+l,y:n.y-32,width:t,height:32})&&(e.deflected=!0,e.velocityY=-8,e.velocityX=(e.x-n.x)/10,a+=10,Y(),s>0&&(s--,0!==s||m||(y=!0)))}"learn"!==m||"meditate"===d||e.deflected||e.onGround||V(e,{x:n.x-8,y:n.y-8,width:n.width+16,height:n.height+16,type:{sprite:X.woman}})&&(u=Math.min(x,u+w),p=O[Math.floor(Math.random()*O.length)],g=120,e.deflected=!0,e.velocityY=-2,e.velocityX=(e.x-n.x)/20),"learn"===m&&"meditate"!==d||e.deflected||e.onGround||!T(e,n)||(f=!0,a>h&&(h=a,localStorage.setItem("umbrellaHighScore",h),document.getElementById("highScore").textContent=h)),!e.onGround&&(e.y>434||e.y<-100||e.x<-100||e.x>612)&&i.splice(t,1)}}if(n.umbrellaOpen){const t="fight"===m?72:48,e="fight"===m?3:2,l="fight"===m?-16:-8,o={x:n.x+l,y:n.y-32,width:t,height:32,type:{sprite:X.umbrellaOpen}};for(let t of r)for(let l=t.obstacles.length-1;l>=0;l--){const i=t.obstacles[l];i.deflected||i.falling||!T(o,i,e,2)||(i.deflected=!0,i.onGround=!1,i.velocityY=-8,i.velocityX=(i.x-n.x)/10,t.obstacles.splice(l,1),t.count--,a+=5,Y(),s>0&&(s--,0!==s||m||(y=!0)))}}for(let t of r)for(let e of t.obstacles)if(!e.falling&&!e.deflected){const t=C(e,!0);e.y<t-2&&(e.falling=!0,e.fallVelocityY=0)}for(let t of r)for(let e of t.obstacles)if(e.falling){e.fallVelocityY+=.3,e.y+=e.fallVelocityY;const t=C(e,!0);e.y>=t&&(e.y=t,e.falling=!1,e.fallVelocityY=0)}for(let t of r)for(let e of t.obstacles)if(!e.deflected&&!e.falling&&T(n,e)){const t=n.x+n.width/2<e.x+e.width/2?1:-1;e.pushVelocityX||(e.pushVelocityX=0),e.pushVelocityX+=.3*t,e.pushVelocityX=Math.max(-2,Math.min(2,e.pushVelocityX))}for(let t of r)for(let l=t.obstacles.length-1;l>=0;l--){const o=t.obstacles[l];if(o.pushVelocityX&&Math.abs(o.pushVelocityX)>.01){if(o.x+=o.pushVelocityX,o.pushVelocityX*=.9,o.x<-o.width||o.x>e){t.obstacles.splice(l,1),t.count--;const e=i.indexOf(o);-1!==e&&i.splice(e,1);continue}const n=Math.floor((o.x+o.width/2)/32);n!==r.indexOf(t)&&n>=0&&n<r.length&&(t.obstacles.splice(l,1),t.count--,r[n].obstacles.push(o),r[n].count++)}}const R=.02*k;Math.random()<R&&i.push(function(){const t=I[Math.floor(Math.random()*I.length)],l=(2+1*Math.random())*S,o={x:Math.random()*(e-2*t.width),y:2*-t.height,width:2*t.width,height:2*t.height,velocityY:l,velocityX:0,type:t,deflected:!1,onGround:!1,trail:[]};if("meteor"===t.name){const n=Math.random()*Math.PI/3-Math.PI/6;o.velocityX=Math.sin(n)*(l+1),o.velocityY=Math.cos(n)*(l+1),o.velocityX<0?o.x=e+2*t.width:o.velocityX>0&&(o.x=2*-t.width)}return o}());for(let t of r)if(t.count>0&&o-32*t.count<=50){f=!0,a>h&&(h=a,localStorage.setItem("umbrellaHighScore",h),document.getElementById("highScore").textContent=h);break}})(),t.fillStyle="#fff",t.fillRect(0,0,e,384),r.forEach(t=>{t.obstacles.forEach(t=>{E(t.type.sprite,t.x,t.y)})}),i.forEach(e=>{e.onGround||function(e){if("meteor"===e.type.name&&!e.onGround&&e.trail.length>0){t.fillStyle="#000";for(let l=0;l<e.trail.length;l++){const o=e.trail[l],n=(e.trail.length,Math.max(1,4-l));for(let e=0;e<n;e++)for(let l=0;l<n;l++)Math.random()>.3&&t.fillRect(o.x+e,o.y+l,1,1)}}E(e.type.sprite,e.x,e.y)}(e)}),function(){if(E(X.woman,n.x,n.y),n.umbrellaOpen)if("fight"===m){const t=3;E(X.umbrellaOpen,n.x-16,n.y-40,t)}else E(X.umbrellaOpen,n.x-8,n.y-32);else E(X.umbrellaClosed,n.x+12,n.y+4)}(),function(){const e="fight"===m?150:100;t.strokeStyle="#000",t.lineWidth=2,t.strokeRect(10,10,e,12),t.fillStyle="#fff",t.fillRect(12,12,e-4,8);const o="fight"===m?150:l,i=Math.max(0,n.power/o*(e-4));t.fillStyle="#000",t.fillRect(12,12,i,8),t.fillStyle="#000",t.font="10px monospace",t.textAlign="left",t.fillText("POWER",10,8)}(),function(){if("learn"!==m)return;t.strokeStyle="#000",t.lineWidth=2,t.strokeRect(10,30,100,12),t.fillStyle="#fff",t.fillRect(12,32,96,8);const e=Math.max(0,u/x*96);t.fillStyle="#000",t.fillRect(12,32,e,8),t.fillStyle="#000",t.font="10px monospace",t.textAlign="left",t.fillText("KNOWLEDGE",10,28)}(),t.fillStyle="#000",t.font="16px monospace",t.textAlign="right",t.fillText("Countdown: "+s,502,20),p&&g>0&&(t.fillStyle="#000",t.font="12px monospace",t.textAlign="center",t.fillText(p,256,252)),function(){if(!y)return;let l,o,n;t.fillStyle="rgba(255, 255, 255, 0.9)",t.fillRect(0,0,e,384),t.strokeStyle="#000",t.lineWidth=4,t.strokeRect(20,40,472,304),t.fillStyle="#000",t.font="11px monospace",t.textAlign="center",m?"learn"!==m||d||(l="I have learned so much, and yet I feel\nmore mystified than before. How can I\nbridge this gap?",o="A) Try to learn faster",n="B) Meditate"):(l="Are these obstacles falling just on me?\nWhy are they keeping me away from\nthose I love? Should I fight them,\nor try to learn more about why\nthey are falling?",o="A) Fight them!",n="B) Learn about them"),l.split("\n").forEach((e,l)=>{t.fillText(e,256,80+16*l)}),t.font="bold 14px monospace",t.fillText(o,256,200),t.fillText(n,256,230),t.font="10px monospace",t.fillText("Press A or B to choose",256,280)}(),f&&(t.fillStyle="#000",t.font="32px monospace",t.textAlign="center",t.fillText("GAME OVER",256,192),t.font="16px monospace",t.fillText("Press SPACE to restart",256,222)),t.strokeStyle="#000",t.lineWidth=2,t.strokeRect(0,0,e,384),requestAnimationFrame(A)}()})();